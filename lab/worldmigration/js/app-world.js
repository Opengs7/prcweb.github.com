(function() {
  var paper = Raphael('container', 1400, 760);

  // Currently selected country
  var current = { country : null, elements : [] };

  // Origin elements
  var origins = [];

  var amountScale = 0.000001;
  var threshold = 100000;
  var template = $('#migration-row').html();
  var mode = 'out';
  var maxCurves = 15;

  var data = {"Canada": {"totalIn": 7202340, "totalOut": 1185392, "out": [{"country": "United States", "amount": 834945}], "in": [{"country": "China", "amount": 543573}, {"country": "Germany", "amount": 199541}, {"country": "Guyana", "amount": 101505}, {"country": "Hong Kong, China", "amount": 250786}, {"country": "India", "amount": 516508}, {"country": "Iran, Islamic Rep.", "amount": 107198}, {"country": "Italy", "amount": 345568}, {"country": "Jamaica", "amount": 143675}, {"country": "Korea, Rep.", "amount": 114549}, {"country": "Netherlands", "amount": 130370}, {"country": "Pakistan", "amount": 155159}, {"country": "Philippines", "amount": 352955}, {"country": "Poland", "amount": 198476}, {"country": "Portugal", "amount": 175072}, {"country": "Sri Lanka", "amount": 123012}, {"country": "United Kingdom", "amount": 674746}, {"country": "United States", "amount": 291652}, {"country": "Vietnam", "amount": 186457}]}, "Turkmenistan": {"totalIn": 207700, "totalOut": 260953, "out": [{"country": "Russian Federation", "amount": 179548}], "in": []}, "Lao PDR": {"totalIn": 18916, "totalOut": 366663, "out": [{"country": "United States", "amount": 192978}], "in": []}, "Lithuania": {"totalIn": 128855, "totalOut": 429016, "out": [], "in": []}, "Cambodia": {"totalIn": 335829, "totalOut": 350485, "out": [{"country": "United States", "amount": 148774}], "in": [{"country": "Thailand", "amount": 142767}, {"country": "Vietnam", "amount": 173694}]}, "Switzerland": {"totalIn": 1762797, "totalOut": 407581, "out": [], "in": [{"country": "France", "amount": 110377}, {"country": "Germany", "amount": 204233}, {"country": "Italy", "amount": 263320}, {"country": "Portugal", "amount": 113320}]}, "Ethiopia": {"totalIn": 547984, "totalOut": 620405, "out": [{"country": "Sudan", "amount": 152094}, {"country": "United States", "amount": 139693}], "in": [{"country": "Eritrea", "amount": 290383}, {"country": "Somalia", "amount": 161179}]}, "Aruba": {"totalIn": 34268, "totalOut": 13709, "out": [], "in": []}, "Swaziland": {"totalIn": 40418, "totalOut": 160485, "out": [{"country": "South Africa", "amount": 135720}], "in": []}, "Argentina": {"totalIn": 1449293, "totalOut": 957190, "out": [{"country": "Spain", "amount": 331173}, {"country": "United States", "amount": 163353}], "in": [{"country": "Bolivia", "amount": 220869}, {"country": "Chile", "amount": 200969}, {"country": "Italy", "amount": 205026}, {"country": "Paraguay", "amount": 307510}, {"country": "Spain", "amount": 127165}, {"country": "Uruguay", "amount": 111222}]}, "Bolivia": {"totalIn": 145817, "totalOut": 684998, "out": [{"country": "Argentina", "amount": 220869}, {"country": "Spain", "amount": 274602}], "in": []}, "Bahamas, The": {"totalIn": 33406, "totalOut": 44098, "out": [], "in": []}, "Burkina Faso": {"totalIn": 1043035, "totalOut": 1578271, "out": [{"country": "C\u00f4te d'Ivoire", "amount": 1310892}], "in": [{"country": "C\u00f4te d'Ivoire", "amount": 842931}]}, "Ghana": {"totalIn": 1851814, "totalOut": 825414, "out": [{"country": "C\u00f4te d'Ivoire", "amount": 111001}, {"country": "Nigeria", "amount": 186015}, {"country": "United States", "amount": 110931}], "in": []}, "Saudi Arabia": {"totalIn": 7288900, "totalOut": 178712, "out": [], "in": [{"country": "Bangladesh", "amount": 447055}, {"country": "Egypt, Arab Rep.", "amount": 1005873}, {"country": "India", "amount": 1452927}, {"country": "Indonesia", "amount": 279409}, {"country": "Jordan", "amount": 172266}, {"country": "Kuwait", "amount": 136916}, {"country": "Pakistan", "amount": 1005873}, {"country": "Philippines", "amount": 558818}, {"country": "Sri Lanka", "amount": 391173}, {"country": "Sudan", "amount": 279409}, {"country": "Syrian Arab Republic", "amount": 111764}, {"country": "West Bank and Gaza", "amount": 122608}, {"country": "Yemen, Rep.", "amount": 894109}]}, "Japan": {"totalIn": 2176219, "totalOut": 771246, "out": [{"country": "United States", "amount": 340393}], "in": [{"country": "Brazil", "amount": 320624}, {"country": "China", "amount": 613890}, {"country": "Korea, Rep.", "amount": 600336}, {"country": "Philippines", "amount": 204929}]}, "Channel Islands": {"totalIn": 74790, "totalOut": 0, "out": [], "in": []}, "American Samoa": {"totalIn": 28370, "totalOut": 45671, "out": [], "in": []}, "Northern Mariana Islands": {"totalIn": 54798, "totalOut": 8933, "out": [], "in": []}, "Slovenia": {"totalIn": 163894, "totalOut": 131895, "out": [], "in": []}, "Guatemala": {"totalIn": 59457, "totalOut": 871981, "out": [{"country": "United States", "amount": 753720}], "in": []}, "Bosnia and Herzegovina": {"totalIn": 27780, "totalOut": 1460639, "out": [{"country": "Austria", "amount": 162362}, {"country": "Croatia", "amount": 532528}, {"country": "Germany", "amount": 252262}, {"country": "United States", "amount": 121495}], "in": []}, "Kuwait": {"totalIn": 2097527, "totalOut": 259358, "out": [{"country": "Saudi Arabia", "amount": 136916}], "in": [{"country": "Bangladesh", "amount": 208893}, {"country": "Egypt, Arab Rep.", "amount": 319483}, {"country": "India", "amount": 393210}, {"country": "Pakistan", "amount": 122878}, {"country": "Sri Lanka", "amount": 208893}, {"country": "Syrian Arab Republic", "amount": 122878}]}, "Russian Federation": {"totalIn": 12270388, "totalOut": 11034681, "out": [{"country": "Belarus", "amount": 680497}, {"country": "Estonia", "amount": 137860}, {"country": "Georgia", "amount": 109968}, {"country": "Germany", "amount": 299596}, {"country": "Israel", "amount": 712261}, {"country": "Kazakhstan", "amount": 2226706}, {"country": "Latvia", "amount": 203920}, {"country": "Moldova", "amount": 147802}, {"country": "Tajikistan", "amount": 191754}, {"country": "Ukraine", "amount": 3684217}, {"country": "United States", "amount": 421459}, {"country": "Uzbekistan", "amount": 404356}], "in": [{"country": "Armenia", "amount": 493126}, {"country": "Azerbaijan", "amount": 866843}, {"country": "Belarus", "amount": 958719}, {"country": "Georgia", "amount": 644390}, {"country": "Kazakhstan", "amount": 2648315}, {"country": "Kyrgyz Republic", "amount": 474882}, {"country": "Latvia", "amount": 105031}, {"country": "Moldova", "amount": 284330}, {"country": "Tajikistan", "amount": 392446}, {"country": "Turkmenistan", "amount": 179548}, {"country": "Ukraine", "amount": 3647234}, {"country": "Uzbekistan", "amount": 940539}]}, "Jordan": {"totalIn": 2972983, "totalOut": 734113, "out": [{"country": "Saudi Arabia", "amount": 172266}, {"country": "West Bank and Gaza", "amount": 369088}], "in": [{"country": "Egypt, Arab Rep.", "amount": 851803}, {"country": "Iraq", "amount": 303791}, {"country": "Sri Lanka", "amount": 102709}, {"country": "Syrian Arab Republic", "amount": 288982}, {"country": "West Bank and Gaza", "amount": 873009}]}, "St. Lucia": {"totalIn": 10180, "totalOut": 40494, "out": [], "in": []}, "Congo, Rep.": {"totalIn": 143203, "totalOut": 208741, "out": [], "in": []}, "Dominica": {"totalIn": 5501, "totalOut": 69687, "out": [], "in": []}, "Liberia": {"totalIn": 96310, "totalOut": 432315, "out": [{"country": "Guinea", "amount": 189437}], "in": []}, "Maldives": {"totalIn": 3280, "totalOut": 1963, "out": [], "in": []}, "Pakistan": {"totalIn": 4233592, "totalOut": 4678730, "out": [{"country": "Canada", "amount": 155159}, {"country": "India", "amount": 1150952}, {"country": "Kuwait", "amount": 122878}, {"country": "Qatar", "amount": 250649}, {"country": "Saudi Arabia", "amount": 1005873}, {"country": "United Arab Emirates", "amount": 453005}, {"country": "United Kingdom", "amount": 451712}, {"country": "United States", "amount": 288011}], "in": []}, "Oman": {"totalIn": 826074, "totalOut": 15337, "out": [], "in": [{"country": "Bangladesh", "amount": 149275}, {"country": "India", "amount": 447824}]}, "Tanzania": {"totalIn": 659202, "totalOut": 317160, "out": [], "in": [{"country": "Burundi", "amount": 151313}, {"country": "Mozambique", "amount": 142615}]}, "Albania": {"totalIn": 89106, "totalOut": 1438451, "out": [{"country": "Greece", "amount": 676846}, {"country": "Italy", "amount": 522647}], "in": []}, "Gabon": {"totalIn": 284127, "totalOut": 25229, "out": [], "in": []}, "Monaco": {"totalIn": 23572, "totalOut": 18533, "out": [], "in": []}, "New Zealand": {"totalIn": 962072, "totalOut": 624623, "out": [{"country": "Australia", "amount": 486982}], "in": [{"country": "United Kingdom", "amount": 268085}]}, "Jamaica": {"totalIn": 29962, "totalOut": 986119, "out": [{"country": "Canada", "amount": 143675}, {"country": "United Kingdom", "amount": 158203}, {"country": "United States", "amount": 649046}], "in": []}, "Greenland": {"totalIn": 5823, "totalOut": 5810, "out": [], "in": []}, "Samoa": {"totalIn": 8976, "totalOut": 120419, "out": [], "in": []}, "Slovak Republic": {"totalIn": 130682, "totalOut": 519716, "out": [{"country": "Czech Republic", "amount": 288276}], "in": []}, "United Arab Emirates": {"totalIn": 3293264, "totalOut": 55907, "out": [], "in": [{"country": "Bangladesh", "amount": 100668}, {"country": "Egypt, Arab Rep.", "amount": 140935}, {"country": "India", "amount": 2185919}, {"country": "Pakistan", "amount": 453005}, {"country": "Philippines", "amount": 120801}, {"country": "Sri Lanka", "amount": 161068}]}, "C\u00f4te d'Ivoire": {"totalIn": 2406713, "totalOut": 1172151, "out": [{"country": "Burkina Faso", "amount": 842931}], "in": [{"country": "Burkina Faso", "amount": 1310892}, {"country": "Ghana", "amount": 111001}, {"country": "Guinea", "amount": 134171}, {"country": "Mali", "amount": 440960}]}, "Uruguay": {"totalIn": 79896, "totalOut": 353634, "out": [{"country": "Argentina", "amount": 111222}], "in": []}, "India": {"totalIn": 5436012, "totalOut": 11360823, "out": [{"country": "Australia", "amount": 209908}, {"country": "Bahrain", "amount": 137402}, {"country": "Bangladesh", "amount": 1052775}, {"country": "Canada", "amount": 516508}, {"country": "Italy", "amount": 100683}, {"country": "Kuwait", "amount": 393210}, {"country": "Malaysia", "amount": 106880}, {"country": "Nepal", "amount": 831432}, {"country": "Oman", "amount": 447824}, {"country": "Qatar", "amount": 250649}, {"country": "Saudi Arabia", "amount": 1452927}, {"country": "Singapore", "amount": 157114}, {"country": "Sri Lanka", "amount": 336352}, {"country": "United Arab Emirates", "amount": 2185919}, {"country": "United Kingdom", "amount": 657792}, {"country": "United States", "amount": 1654272}], "in": [{"country": "Bangladesh", "amount": 3299268}, {"country": "Nepal", "amount": 564906}, {"country": "Pakistan", "amount": 1150952}, {"country": "Sri Lanka", "amount": 161472}]}, "Azerbaijan": {"totalIn": 263940, "totalOut": 1433513, "out": [{"country": "Armenia", "amount": 164483}, {"country": "Russian Federation", "amount": 866843}], "in": []}, "Lesotho": {"totalIn": 6328, "totalOut": 428039, "out": [{"country": "South Africa", "amount": 350657}], "in": []}, "Kenya": {"totalIn": 817747, "totalOut": 457303, "out": [{"country": "United Kingdom", "amount": 152999}], "in": [{"country": "Uganda", "amount": 531218}]}, "Tajikistan": {"totalIn": 284291, "totalOut": 791618, "out": [{"country": "Russian Federation", "amount": 392446}, {"country": "Uzbekistan", "amount": 227988}], "in": [{"country": "Russian Federation", "amount": 191754}]}, "Guam": {"totalIn": 78887, "totalOut": 48689, "out": [], "in": []}, "Turkey": {"totalIn": 1410947, "totalOut": 4261786, "out": [{"country": "Austria", "amount": 160698}, {"country": "France", "amount": 299547}, {"country": "Germany", "amount": 2733109}, {"country": "Netherlands", "amount": 195029}, {"country": "United States", "amount": 107284}], "in": [{"country": "Bulgaria", "amount": 538686}, {"country": "Germany", "amount": 306456}]}, "Afghanistan": {"totalIn": 90883, "totalOut": 2351104, "out": [{"country": "Iran, Islamic Rep.", "amount": 1704199}], "in": []}, "Venezuela, RB": {"totalIn": 1007380, "totalOut": 521620, "out": [{"country": "Spain", "amount": 164239}, {"country": "United States", "amount": 171891}], "in": [{"country": "Colombia", "amount": 604514}]}, "Bangladesh": {"totalIn": 1085345, "totalOut": 5384875, "out": [{"country": "India", "amount": 3299268}, {"country": "Kuwait", "amount": 208893}, {"country": "Malaysia", "amount": 122912}, {"country": "Oman", "amount": 149275}, {"country": "Saudi Arabia", "amount": 447055}, {"country": "United Arab Emirates", "amount": 100668}, {"country": "United Kingdom", "amount": 210244}, {"country": "United States", "amount": 148326}], "in": [{"country": "India", "amount": 1052775}]}, "Mauritania": {"totalIn": 99229, "totalOut": 118099, "out": [], "in": []}, "Solomon Islands": {"totalIn": 6971, "totalOut": 5385, "out": [], "in": []}, "Lebanon": {"totalIn": 758167, "totalOut": 664073, "out": [{"country": "United States", "amount": 130237}], "in": []}, "San Marino": {"totalIn": 11683, "totalOut": 3111, "out": [], "in": []}, "French Polynesia": {"totalIn": 34803, "totalOut": 4158, "out": [], "in": []}, "France": {"totalIn": 6684842, "totalOut": 1738006, "out": [{"country": "Belgium", "amount": 174750}, {"country": "Germany", "amount": 169945}, {"country": "Portugal", "amount": 134355}, {"country": "Spain", "amount": 252618}, {"country": "Switzerland", "amount": 110377}, {"country": "United Kingdom", "amount": 128020}, {"country": "United States", "amount": 160721}], "in": [{"country": "Algeria", "amount": 913794}, {"country": "Belgium", "amount": 137974}, {"country": "Germany", "amount": 170959}, {"country": "Italy", "amount": 450394}, {"country": "Morocco", "amount": 840985}, {"country": "Poland", "amount": 122152}, {"country": "Portugal", "amount": 762411}, {"country": "Spain", "amount": 364177}, {"country": "Tunisia", "amount": 302363}, {"country": "Turkey", "amount": 299547}, {"country": "United Kingdom", "amount": 172836}]}, "Syrian Arab Republic": {"totalIn": 2205847, "totalOut": 945099, "out": [{"country": "Jordan", "amount": 288982}, {"country": "Kuwait", "amount": 122878}, {"country": "Saudi Arabia", "amount": 111764}], "in": [{"country": "West Bank and Gaza", "amount": 1541297}]}, "Bermuda": {"totalIn": 19942, "totalOut": 15679, "out": [], "in": []}, "Somalia": {"totalIn": 22843, "totalOut": 813273, "out": [{"country": "Ethiopia", "amount": 161179}, {"country": "United Kingdom", "amount": 110326}, {"country": "United States", "amount": 109618}], "in": []}, "Peru": {"totalIn": 37625, "totalOut": 1091079, "out": [{"country": "Spain", "amount": 184832}, {"country": "United States", "amount": 392455}], "in": []}, "Vanuatu": {"totalIn": 814, "totalOut": 3890, "out": [], "in": []}, "Nigeria": {"totalIn": 1127668, "totalOut": 1000523, "out": [{"country": "Chad", "amount": 114025}, {"country": "United Kingdom", "amount": 150918}, {"country": "United States", "amount": 210647}], "in": [{"country": "Benin", "amount": 238561}, {"country": "Ghana", "amount": 186015}, {"country": "Mali", "amount": 133464}, {"country": "Togo", "amount": 115791}]}, "Seychelles": {"totalIn": 10838, "totalOut": 12314, "out": [], "in": []}, "Norway": {"totalIn": 485444, "totalOut": 183936, "out": [], "in": []}, "Malawi": {"totalIn": 275851, "totalOut": 212819, "out": [], "in": [{"country": "Mozambique", "amount": 159945}]}, "West Bank and Gaza": {"totalIn": 1923808, "totalOut": 3017140, "out": [{"country": "Jordan", "amount": 873009}, {"country": "Saudi Arabia", "amount": 122608}, {"country": "Syrian Arab Republic", "amount": 1541297}], "in": [{"country": "Egypt, Arab Rep.", "amount": 119564}, {"country": "Israel", "amount": 655814}, {"country": "Jordan", "amount": 369088}]}, "Benin": {"totalIn": 232036, "totalOut": 532166, "out": [{"country": "Nigeria", "amount": 238561}], "in": []}, "Macao, China": {"totalIn": 299692, "totalOut": 97851, "out": [], "in": [{"country": "China", "amount": 246441}]}, "Cuba": {"totalIn": 15259, "totalOut": 1219244, "out": [{"country": "Spain", "amount": 105748}, {"country": "United States", "amount": 993729}], "in": []}, "Cameroon": {"totalIn": 196570, "totalOut": 279388, "out": [], "in": []}, "Montenegro": {"totalIn": 42509, "totalOut": 36, "out": [], "in": []}, "Togo": {"totalIn": 185402, "totalOut": 369035, "out": [{"country": "Nigeria", "amount": 115791}], "in": []}, "China": {"totalIn": 685775, "totalOut": 8344726, "out": [{"country": "Australia", "amount": 295364}, {"country": "Canada", "amount": 543573}, {"country": "Germany", "amount": 124563}, {"country": "Hong Kong, China", "amount": 2224503}, {"country": "Italy", "amount": 203519}, {"country": "Japan", "amount": 613890}, {"country": "Korea, Rep.", "amount": 281685}, {"country": "Macao, China", "amount": 246441}, {"country": "Malaysia", "amount": 125584}, {"country": "Singapore", "amount": 497929}, {"country": "Spain", "amount": 144205}, {"country": "Thailand", "amount": 376487}, {"country": "United Kingdom", "amount": 100959}, {"country": "United States", "amount": 1736314}], "in": []}, "Armenia": {"totalIn": 324184, "totalOut": 870458, "out": [{"country": "Russian Federation", "amount": 493126}], "in": [{"country": "Azerbaijan", "amount": 164483}]}, "Timor-Leste": {"totalIn": 13836, "totalOut": 16810, "out": [], "in": []}, "Dominican Republic": {"totalIn": 434343, "totalOut": 1035963, "out": [{"country": "Spain", "amount": 130832}, {"country": "United States", "amount": 787015}], "in": [{"country": "Haiti", "amount": 279216}]}, "Ukraine": {"totalIn": 5257527, "totalOut": 6525145, "out": [{"country": "Belarus", "amount": 141266}, {"country": "Germany", "amount": 202501}, {"country": "Israel", "amount": 248699}, {"country": "Italy", "amount": 172571}, {"country": "Kazakhstan", "amount": 271951}, {"country": "Moldova", "amount": 189906}, {"country": "Poland", "amount": 332950}, {"country": "Russian Federation", "amount": 3647234}, {"country": "United States", "amount": 332155}], "in": [{"country": "Belarus", "amount": 276070}, {"country": "Kazakhstan", "amount": 249886}, {"country": "Moldova", "amount": 168370}, {"country": "Russian Federation", "amount": 3684217}, {"country": "Uzbekistan", "amount": 247151}]}, "Bahrain": {"totalIn": 315403, "totalOut": 30015, "out": [], "in": [{"country": "India", "amount": 137402}]}, "Tonga": {"totalIn": 848, "totalOut": 47369, "out": [], "in": []}, "Finland": {"totalIn": 225646, "totalOut": 329269, "out": [{"country": "Sweden", "amount": 189535}], "in": []}, "Libya": {"totalIn": 682482, "totalOut": 110080, "out": [], "in": [{"country": "Egypt, Arab Rep.", "amount": 397064}]}, "Cayman Islands": {"totalIn": 35684, "totalOut": 3935, "out": [], "in": []}, "Central African Republic": {"totalIn": 80492, "totalOut": 129394, "out": [], "in": []}, "Mauritius": {"totalIn": 42917, "totalOut": 140717, "out": [], "in": []}, "Liechtenstein": {"totalIn": 12538, "totalOut": 6171, "out": [], "in": []}, "Belarus": {"totalIn": 1090378, "totalOut": 1765877, "out": [{"country": "Poland", "amount": 112197}, {"country": "Russian Federation", "amount": 958719}, {"country": "Ukraine", "amount": 276070}], "in": [{"country": "Poland", "amount": 235853}, {"country": "Russian Federation", "amount": 680497}, {"country": "Ukraine", "amount": 141266}]}, "Mali": {"totalIn": 162677, "totalOut": 1013760, "out": [{"country": "C\u00f4te d'Ivoire", "amount": 440960}, {"country": "Nigeria", "amount": 133464}], "in": []}, "Micronesia, Fed. Sts.": {"totalIn": 2668, "totalOut": 21895, "out": [], "in": []}, "Korea, Dem. Rep.": {"totalIn": 37121, "totalOut": 300782, "out": [{"country": "United States", "amount": 289854}], "in": []}, "Bulgaria": {"totalIn": 107245, "totalOut": 1201191, "out": [{"country": "Spain", "amount": 173255}, {"country": "Turkey", "amount": 538686}], "in": []}, "United States": {"totalIn": 42813281, "totalOut": 2423175, "out": [{"country": "Canada", "amount": 291652}, {"country": "Germany", "amount": 159326}, {"country": "Mexico", "amount": 509251}, {"country": "Puerto Rico", "amount": 202051}, {"country": "United Kingdom", "amount": 183183}], "in": [{"country": "Argentina", "amount": 163353}, {"country": "Bangladesh", "amount": 148326}, {"country": "Bosnia and Herzegovina", "amount": 121495}, {"country": "Brazil", "amount": 339141}, {"country": "Cambodia", "amount": 148774}, {"country": "Canada", "amount": 834945}, {"country": "China", "amount": 1736314}, {"country": "Colombia", "amount": 611971}, {"country": "Cuba", "amount": 993729}, {"country": "Dominican Republic", "amount": 787015}, {"country": "Ecuador", "amount": 420751}, {"country": "Egypt, Arab Rep.", "amount": 132513}, {"country": "El Salvador", "amount": 1116420}, {"country": "Ethiopia", "amount": 139693}, {"country": "France", "amount": 160721}, {"country": "Germany", "amount": 653968}, {"country": "Ghana", "amount": 110931}, {"country": "Greece", "amount": 151239}, {"country": "Guatemala", "amount": 753720}, {"country": "Guyana", "amount": 263147}, {"country": "Haiti", "amount": 545437}, {"country": "Honduras", "amount": 469202}, {"country": "Hong Kong, China", "amount": 214572}, {"country": "India", "amount": 1654272}, {"country": "Iran, Islamic Rep.", "amount": 351685}, {"country": "Iraq", "amount": 102942}, {"country": "Ireland", "amount": 137537}, {"country": "Israel", "amount": 149039}, {"country": "Italy", "amount": 400484}, {"country": "Jamaica", "amount": 649046}, {"country": "Japan", "amount": 340393}, {"country": "Korea, Dem. Rep.", "amount": 289854}, {"country": "Korea, Rep.", "amount": 1050860}, {"country": "Lao PDR", "amount": 192978}, {"country": "Lebanon", "amount": 130237}, {"country": "Mexico", "amount": 11635995}, {"country": "Nicaragua", "amount": 242886}, {"country": "Nigeria", "amount": 210647}, {"country": "Pakistan", "amount": 288011}, {"country": "Peru", "amount": 392455}, {"country": "Philippines", "amount": 1717771}, {"country": "Poland", "amount": 487934}, {"country": "Portugal", "amount": 176694}, {"country": "Puerto Rico", "amount": 1651031}, {"country": "Romania", "amount": 171253}, {"country": "Russian Federation", "amount": 421459}, {"country": "Somalia", "amount": 109618}, {"country": "Thailand", "amount": 202971}, {"country": "Trinidad and Tobago", "amount": 229650}, {"country": "Turkey", "amount": 107284}, {"country": "Ukraine", "amount": 332155}, {"country": "United Kingdom", "amount": 701093}, {"country": "Venezuela, RB", "amount": 171891}, {"country": "Vietnam", "amount": 1160309}]}, "Romania": {"totalIn": 132757, "totalOut": 2769053, "out": [{"country": "Germany", "amount": 134911}, {"country": "Hungary", "amount": 189055}, {"country": "Israel", "amount": 182099}, {"country": "Italy", "amount": 813037}, {"country": "Spain", "amount": 810471}, {"country": "United States", "amount": 171253}], "in": []}, "Angola": {"totalIn": 65387, "totalOut": 533593, "out": [{"country": "Portugal", "amount": 245650}], "in": []}, "Egypt, Arab Rep.": {"totalIn": 244714, "totalOut": 3741055, "out": [{"country": "Jordan", "amount": 851803}, {"country": "Kuwait", "amount": 319483}, {"country": "Libya", "amount": 397064}, {"country": "Saudi Arabia", "amount": 1005873}, {"country": "United Arab Emirates", "amount": 140935}, {"country": "United States", "amount": 132513}, {"country": "West Bank and Gaza", "amount": 119564}], "in": []}, "South Africa": {"totalIn": 1862889, "totalOut": 878373, "out": [{"country": "Australia", "amount": 132756}, {"country": "Mozambique", "amount": 154579}, {"country": "United Kingdom", "amount": 225856}], "in": [{"country": "Lesotho", "amount": 350657}, {"country": "Mozambique", "amount": 454548}, {"country": "Swaziland", "amount": 135720}, {"country": "Zimbabwe", "amount": 858993}]}, "St. Vincent and the Grenadines": {"totalIn": 8611, "totalOut": 41225, "out": [], "in": []}, "Cyprus": {"totalIn": 154253, "totalOut": 149557, "out": [], "in": []}, "Brunei Darussalam": {"totalIn": 148123, "totalOut": 24343, "out": [], "in": []}, "Qatar": {"totalIn": 1305428, "totalOut": 9849, "out": [], "in": [{"country": "India", "amount": 250649}, {"country": "Iran, Islamic Rep.", "amount": 150389}, {"country": "Nepal", "amount": 175454}, {"country": "Pakistan", "amount": 250649}, {"country": "Philippines", "amount": 125324}]}, "Malaysia": {"totalIn": 2357603, "totalOut": 1481202, "out": [{"country": "Australia", "amount": 119197}, {"country": "Singapore", "amount": 1060628}], "in": [{"country": "Bangladesh", "amount": 122912}, {"country": "China", "amount": 125584}, {"country": "India", "amount": 106880}, {"country": "Indonesia", "amount": 1397684}, {"country": "Philippines", "amount": 277444}, {"country": "Singapore", "amount": 103318}]}, "Austria": {"totalIn": 1310218, "totalOut": 597639, "out": [{"country": "Germany", "amount": 280520}], "in": [{"country": "Bosnia and Herzegovina", "amount": 162362}, {"country": "Germany", "amount": 202093}, {"country": "Serbia", "amount": 130844}, {"country": "Turkey", "amount": 160698}]}, "Vietnam": {"totalIn": 69307, "totalOut": 2226401, "out": [{"country": "Australia", "amount": 197610}, {"country": "Cambodia", "amount": 173694}, {"country": "Canada", "amount": 186457}, {"country": "Germany", "amount": 132916}, {"country": "United States", "amount": 1160309}], "in": []}, "Mozambique": {"totalIn": 450020, "totalOut": 1179803, "out": [{"country": "Malawi", "amount": 159945}, {"country": "Portugal", "amount": 107190}, {"country": "South Africa", "amount": 454548}, {"country": "Tanzania", "amount": 142615}, {"country": "Zimbabwe", "amount": 158722}], "in": [{"country": "South Africa", "amount": 154579}]}, "Uganda": {"totalIn": 646548, "totalOut": 758294, "out": [{"country": "Kenya", "amount": 531218}], "in": [{"country": "Burundi", "amount": 101826}, {"country": "Rwanda", "amount": 123860}, {"country": "Sudan", "amount": 191103}]}, "Kyrgyz Republic": {"totalIn": 222731, "totalOut": 621076, "out": [{"country": "Russian Federation", "amount": 474882}], "in": []}, "Hungary": {"totalIn": 368076, "totalOut": 462418, "out": [], "in": [{"country": "Romania", "amount": 189055}]}, "Niger": {"totalIn": 202163, "totalOut": 387330, "out": [], "in": []}, "Isle of Man": {"totalIn": 43947, "totalOut": 0, "out": [], "in": []}, "Brazil": {"totalIn": 688026, "totalOut": 1367287, "out": [{"country": "Japan", "amount": 320624}, {"country": "Spain", "amount": 162205}, {"country": "United States", "amount": 339141}], "in": [{"country": "Portugal", "amount": 214511}]}, "Virgin Islands (U.S.)": {"totalIn": 61798, "totalOut": 51121, "out": [], "in": []}, "Guinea": {"totalIn": 394557, "totalOut": 533308, "out": [{"country": "C\u00f4te d'Ivoire", "amount": 134171}], "in": [{"country": "Liberia", "amount": 189437}, {"country": "Sierra Leone", "amount": 157067}]}, "Panama": {"totalIn": 121003, "totalOut": 141141, "out": [], "in": []}, "Costa Rica": {"totalIn": 489201, "totalOut": 125300, "out": [], "in": [{"country": "Nicaragua", "amount": 373548}]}, "Luxembourg": {"totalIn": 173232, "totalOut": 57787, "out": [], "in": []}, "Cape Verde": {"totalIn": 12053, "totalOut": 192531, "out": [], "in": []}, "Andorra": {"totalIn": 55847, "totalOut": 9253, "out": [], "in": []}, "Gibraltar": {"totalIn": 0, "totalOut": 0, "out": [], "in": []}, "Ireland": {"totalIn": 898630, "totalOut": 736889, "out": [{"country": "United Kingdom", "amount": 422569}, {"country": "United States", "amount": 137537}], "in": [{"country": "United Kingdom", "amount": 397465}]}, "Palau": {"totalIn": 5776, "totalOut": 7971, "out": [], "in": []}, "Faeroe Islands": {"totalIn": 3262, "totalOut": 759, "out": [], "in": []}, "Ecuador": {"totalIn": 393641, "totalOut": 1147902, "out": [{"country": "Spain", "amount": 519123}, {"country": "United States", "amount": 420751}], "in": [{"country": "Colombia", "amount": 170255}]}, "Czech Republic": {"totalIn": 453041, "totalOut": 369737, "out": [], "in": [{"country": "Slovak Republic", "amount": 288276}]}, "Australia": {"totalIn": 5522408, "totalOut": 442632, "out": [{"country": "United Kingdom", "amount": 121775}], "in": [{"country": "China", "amount": 295364}, {"country": "Germany", "amount": 131810}, {"country": "Greece", "amount": 140114}, {"country": "India", "amount": 209908}, {"country": "Italy", "amount": 236606}, {"country": "Malaysia", "amount": 119197}, {"country": "New Zealand", "amount": 486982}, {"country": "Philippines", "amount": 151676}, {"country": "South Africa", "amount": 132756}, {"country": "United Kingdom", "amount": 1207837}, {"country": "Vietnam", "amount": 197610}]}, "Algeria": {"totalIn": 242324, "totalOut": 1211118, "out": [{"country": "France", "amount": 913794}], "in": []}, "El Salvador": {"totalIn": 40324, "totalOut": 1269190, "out": [{"country": "United States", "amount": 1116420}], "in": []}, "Tuvalu": {"totalIn": 0, "totalOut": 0, "out": [], "in": []}, "St. Kitts and Nevis": {"totalIn": 5046, "totalOut": 31974, "out": [], "in": []}, "Marshall Islands": {"totalIn": 1709, "totalOut": 10506, "out": [], "in": []}, "Chile": {"totalIn": 320397, "totalOut": 634001, "out": [{"country": "Argentina", "amount": 200969}], "in": []}, "Puerto Rico": {"totalIn": 323962, "totalOut": 1705207, "out": [{"country": "United States", "amount": 1651031}], "in": [{"country": "United States", "amount": 202051}]}, "Belgium": {"totalIn": 1465677, "totalOut": 454522, "out": [{"country": "France", "amount": 137974}], "in": [{"country": "France", "amount": 174750}, {"country": "Italy", "amount": 129769}, {"country": "Morocco", "amount": 172682}, {"country": "Netherlands", "amount": 127812}]}, "Kiribati": {"totalIn": 1978, "totalOut": 6429, "out": [], "in": []}, "Haiti": {"totalIn": 34966, "totalOut": 1009751, "out": [{"country": "Dominican Republic", "amount": 279216}, {"country": "United States", "amount": 545437}], "in": []}, "Belize": {"totalIn": 46807, "totalOut": 50245, "out": [], "in": []}, "Sierra Leone": {"totalIn": 106776, "totalOut": 267208, "out": [{"country": "Guinea", "amount": 157067}], "in": []}, "Georgia": {"totalIn": 167269, "totalOut": 1058300, "out": [{"country": "Russian Federation", "amount": 644390}], "in": [{"country": "Russian Federation", "amount": 109968}]}, "Denmark": {"totalIn": 483714, "totalOut": 259358, "out": [], "in": []}, "Philippines": {"totalIn": 435423, "totalOut": 4275612, "out": [{"country": "Australia", "amount": 151676}, {"country": "Canada", "amount": 352955}, {"country": "Italy", "amount": 137407}, {"country": "Japan", "amount": 204929}, {"country": "Malaysia", "amount": 277444}, {"country": "Qatar", "amount": 125324}, {"country": "Saudi Arabia", "amount": 558818}, {"country": "United Arab Emirates", "amount": 120801}, {"country": "United Kingdom", "amount": 114489}, {"country": "United States", "amount": 1717771}], "in": []}, "Moldova": {"totalIn": 408319, "totalOut": 770528, "out": [{"country": "Russian Federation", "amount": 284330}, {"country": "Ukraine", "amount": 168370}], "in": [{"country": "Russian Federation", "amount": 147802}, {"country": "Ukraine", "amount": 189906}]}, "Portugal": {"totalIn": 918626, "totalOut": 2229620, "out": [{"country": "Brazil", "amount": 214511}, {"country": "Canada", "amount": 175072}, {"country": "France", "amount": 762411}, {"country": "Germany", "amount": 182710}, {"country": "Spain", "amount": 156062}, {"country": "Switzerland", "amount": 113320}, {"country": "United States", "amount": 176694}], "in": [{"country": "Angola", "amount": 245650}, {"country": "France", "amount": 134355}, {"country": "Mozambique", "amount": 107190}]}, "Morocco": {"totalIn": 49098, "totalOut": 3016631, "out": [{"country": "Belgium", "amount": 172682}, {"country": "France", "amount": 840985}, {"country": "Germany", "amount": 108442}, {"country": "Israel", "amount": 245574}, {"country": "Italy", "amount": 475783}, {"country": "Netherlands", "amount": 167355}, {"country": "Spain", "amount": 778451}], "in": []}, "Croatia": {"totalIn": 699947, "totalOut": 753529, "out": [{"country": "Germany", "amount": 359367}], "in": [{"country": "Bosnia and Herzegovina", "amount": 532528}]}, "Mongolia": {"totalIn": 10022, "totalOut": 32051, "out": [], "in": []}, "Guinea-Bissau": {"totalIn": 19244, "totalOut": 111374, "out": [], "in": []}, "Thailand": {"totalIn": 1157263, "totalOut": 811123, "out": [{"country": "Cambodia", "amount": 142767}, {"country": "United States", "amount": 202971}], "in": [{"country": "China", "amount": 376487}, {"country": "Myanmar", "amount": 288487}]}, "Macedonia, FYR": {"totalIn": 129701, "totalOut": 447138, "out": [{"country": "Italy", "amount": 101539}], "in": []}, "Grenada": {"totalIn": 12597, "totalOut": 68362, "out": [], "in": []}, "Yemen, Rep.": {"totalIn": 517926, "totalOut": 1134687, "out": [{"country": "Saudi Arabia", "amount": 894109}], "in": [{"country": "Sudan", "amount": 126109}]}, "Iraq": {"totalIn": 83380, "totalOut": 1546767, "out": [{"country": "Germany", "amount": 115792}, {"country": "Iran, Islamic Rep.", "amount": 379356}, {"country": "Israel", "amount": 111935}, {"country": "Jordan", "amount": 303791}, {"country": "Sweden", "amount": 103728}, {"country": "United States", "amount": 102942}], "in": []}, "Chad": {"totalIn": 388251, "totalOut": 243544, "out": [], "in": [{"country": "Nigeria", "amount": 114025}]}, "Estonia": {"totalIn": 182464, "totalOut": 169213, "out": [], "in": [{"country": "Russian Federation", "amount": 137860}]}, "Kosovo": {"totalIn": 0, "totalOut": 25252, "out": [], "in": []}, "Sweden": {"totalIn": 1306020, "totalOut": 317605, "out": [], "in": [{"country": "Finland", "amount": 189535}, {"country": "Iraq", "amount": 103728}]}, "Mexico": {"totalIn": 725684, "totalOut": 11859236, "out": [{"country": "United States", "amount": 11635995}], "in": [{"country": "United States", "amount": 509251}]}, "Korea, Rep.": {"totalIn": 534817, "totalOut": 2077730, "out": [{"country": "Canada", "amount": 114549}, {"country": "Japan", "amount": 600336}, {"country": "United States", "amount": 1050860}], "in": [{"country": "China", "amount": 281685}]}, "Uzbekistan": {"totalIn": 1175935, "totalOut": 1954460, "out": [{"country": "Israel", "amount": 101519}, {"country": "Kazakhstan", "amount": 184266}, {"country": "Russian Federation", "amount": 940539}, {"country": "Ukraine", "amount": 247151}], "in": [{"country": "Kazakhstan", "amount": 197773}, {"country": "Russian Federation", "amount": 404356}, {"country": "Tajikistan", "amount": 227988}]}, "Djibouti": {"totalIn": 114147, "totalOut": 13484, "out": [], "in": []}, "Rwanda": {"totalIn": 465480, "totalOut": 263641, "out": [{"country": "Uganda", "amount": 123860}], "in": [{"country": "Congo, Dem. Rep.", "amount": 372964}]}, "Antigua and Barbuda": {"totalIn": 20928, "totalOut": 42170, "out": [], "in": []}, "Spain": {"totalIn": 6900547, "totalOut": 1373024, "out": [{"country": "Argentina", "amount": 127165}, {"country": "France", "amount": 364177}, {"country": "Germany", "amount": 169550}], "in": [{"country": "Argentina", "amount": 331173}, {"country": "Bolivia", "amount": 274602}, {"country": "Brazil", "amount": 162205}, {"country": "Bulgaria", "amount": 173255}, {"country": "China", "amount": 144205}, {"country": "Colombia", "amount": 375710}, {"country": "Cuba", "amount": 105748}, {"country": "Dominican Republic", "amount": 130832}, {"country": "Ecuador", "amount": 519123}, {"country": "France", "amount": 252618}, {"country": "Germany", "amount": 272821}, {"country": "Morocco", "amount": 778451}, {"country": "Peru", "amount": 184832}, {"country": "Portugal", "amount": 156062}, {"country": "Romania", "amount": 810471}, {"country": "United Kingdom", "amount": 411074}, {"country": "Venezuela, RB", "amount": 164239}]}, "Colombia": {"totalIn": 110297, "totalOut": 2123237, "out": [{"country": "Ecuador", "amount": 170255}, {"country": "Spain", "amount": 375710}, {"country": "United States", "amount": 611971}, {"country": "Venezuela, RB", "amount": 604514}], "in": []}, "Burundi": {"totalIn": 60770, "totalOut": 356427, "out": [{"country": "Tanzania", "amount": 151313}, {"country": "Uganda", "amount": 101826}], "in": []}, "Fiji": {"totalIn": 18533, "totalOut": 182183, "out": [], "in": []}, "Barbados": {"totalIn": 28080, "totalOut": 105174, "out": [], "in": []}, "Madagascar": {"totalIn": 37762, "totalOut": 79811, "out": [], "in": []}, "Italy": {"totalIn": 4463413, "totalOut": 3480280, "out": [{"country": "Argentina", "amount": 205026}, {"country": "Australia", "amount": 236606}, {"country": "Belgium", "amount": 129769}, {"country": "Canada", "amount": 345568}, {"country": "France", "amount": 450394}, {"country": "Germany", "amount": 842666}, {"country": "Switzerland", "amount": 263320}, {"country": "United Kingdom", "amount": 108244}, {"country": "United States", "amount": 400484}], "in": [{"country": "Albania", "amount": 522647}, {"country": "China", "amount": 203519}, {"country": "India", "amount": 100683}, {"country": "Macedonia, FYR", "amount": 101539}, {"country": "Morocco", "amount": 475783}, {"country": "Philippines", "amount": 137407}, {"country": "Poland", "amount": 117309}, {"country": "Romania", "amount": 813037}, {"country": "Tunisia", "amount": 121708}, {"country": "Ukraine", "amount": 172571}]}, "Bhutan": {"totalIn": 40246, "totalOut": 44659, "out": [], "in": []}, "Sudan": {"totalIn": 753447, "totalOut": 968141, "out": [{"country": "Saudi Arabia", "amount": 279409}, {"country": "Uganda", "amount": 191103}, {"country": "Yemen, Rep.", "amount": 126109}], "in": [{"country": "Eritrea", "amount": 458042}, {"country": "Ethiopia", "amount": 152094}]}, "Nepal": {"totalIn": 945865, "totalOut": 983567, "out": [{"country": "India", "amount": 564906}, {"country": "Qatar", "amount": 175454}], "in": [{"country": "India", "amount": 831432}]}, "Singapore": {"totalIn": 1966865, "totalOut": 297234, "out": [{"country": "Malaysia", "amount": 103318}], "in": [{"country": "China", "amount": 497929}, {"country": "India", "amount": 157114}, {"country": "Indonesia", "amount": 102332}, {"country": "Malaysia", "amount": 1060628}]}, "Malta": {"totalIn": 15456, "totalOut": 107412, "out": [], "in": []}, "Netherlands": {"totalIn": 1752869, "totalOut": 992913, "out": [{"country": "Belgium", "amount": 127812}, {"country": "Canada", "amount": 130370}, {"country": "Germany", "amount": 204466}], "in": [{"country": "Germany", "amount": 117170}, {"country": "Indonesia", "amount": 146854}, {"country": "Morocco", "amount": 167355}, {"country": "Suriname", "amount": 187219}, {"country": "Turkey", "amount": 195029}]}, "Suriname": {"totalIn": 39474, "totalOut": 204431, "out": [{"country": "Netherlands", "amount": 187219}], "in": []}, "S\u00e3o Tom\u00e9 and Principe": {"totalIn": 5253, "totalOut": 36179, "out": [], "in": []}, "Turks and Caicos Islands": {"totalIn": 0, "totalOut": 0, "out": [], "in": []}, "Netherlands Antilles": {"totalIn": 53032, "totalOut": 101862, "out": [], "in": []}, "Iran, Islamic Rep.": {"totalIn": 2128685, "totalOut": 1295173, "out": [{"country": "Canada", "amount": 107198}, {"country": "Qatar", "amount": 150389}, {"country": "United States", "amount": 351685}], "in": [{"country": "Afghanistan", "amount": 1704199}, {"country": "Iraq", "amount": 379356}]}, "Israel": {"totalIn": 2940494, "totalOut": 1020565, "out": [{"country": "United States", "amount": 149039}, {"country": "West Bank and Gaza", "amount": 655814}], "in": [{"country": "Iraq", "amount": 111935}, {"country": "Morocco", "amount": 245574}, {"country": "Poland", "amount": 117287}, {"country": "Romania", "amount": 182099}, {"country": "Russian Federation", "amount": 712261}, {"country": "Ukraine", "amount": 248699}, {"country": "Uzbekistan", "amount": 101519}]}, "Indonesia": {"totalIn": 122908, "totalOut": 2504297, "out": [{"country": "Malaysia", "amount": 1397684}, {"country": "Netherlands", "amount": 146854}, {"country": "Saudi Arabia", "amount": 279409}, {"country": "Singapore", "amount": 102332}], "in": []}, "Iceland": {"totalIn": 37223, "totalOut": 42693, "out": [], "in": []}, "Zambia": {"totalIn": 233140, "totalOut": 185904, "out": [], "in": []}, "Senegal": {"totalIn": 210061, "totalOut": 636633, "out": [{"country": "Gambia, The", "amount": 177306}], "in": []}, "Papua New Guinea": {"totalIn": 24546, "totalOut": 61197, "out": [], "in": []}, "Trinidad and Tobago": {"totalIn": 34348, "totalOut": 358468, "out": [{"country": "United States", "amount": 229650}], "in": []}, "Zimbabwe": {"totalIn": 372258, "totalOut": 1254353, "out": [{"country": "South Africa", "amount": 858993}, {"country": "United Kingdom", "amount": 115530}], "in": [{"country": "Mozambique", "amount": 158722}]}, "Germany": {"totalIn": 10758061, "totalOut": 3529460, "out": [{"country": "Australia", "amount": 131810}, {"country": "Austria", "amount": 202093}, {"country": "Canada", "amount": 199541}, {"country": "France", "amount": 170959}, {"country": "Kazakhstan", "amount": 175667}, {"country": "Netherlands", "amount": 117170}, {"country": "Poland", "amount": 104710}, {"country": "Spain", "amount": 272821}, {"country": "Switzerland", "amount": 204233}, {"country": "Turkey", "amount": 306456}, {"country": "United Kingdom", "amount": 299753}, {"country": "United States", "amount": 653968}], "in": [{"country": "Austria", "amount": 280520}, {"country": "Bosnia and Herzegovina", "amount": 252262}, {"country": "China", "amount": 124563}, {"country": "Croatia", "amount": 359367}, {"country": "France", "amount": 169945}, {"country": "Greece", "amount": 470350}, {"country": "Iraq", "amount": 115792}, {"country": "Italy", "amount": 842666}, {"country": "Morocco", "amount": 108442}, {"country": "Netherlands", "amount": 204466}, {"country": "Poland", "amount": 613768}, {"country": "Portugal", "amount": 182710}, {"country": "Romania", "amount": 134911}, {"country": "Russian Federation", "amount": 299596}, {"country": "Spain", "amount": 169550}, {"country": "Turkey", "amount": 2733109}, {"country": "Ukraine", "amount": 202501}, {"country": "United Kingdom", "amount": 154826}, {"country": "United States", "amount": 159326}, {"country": "Vietnam", "amount": 132916}]}, "Kazakhstan": {"totalIn": 3079491, "totalOut": 3719766, "out": [{"country": "Russian Federation", "amount": 2648315}, {"country": "Ukraine", "amount": 249886}, {"country": "Uzbekistan", "amount": 197773}], "in": [{"country": "Germany", "amount": 175667}, {"country": "Russian Federation", "amount": 2226706}, {"country": "Ukraine", "amount": 271951}, {"country": "Uzbekistan", "amount": 184266}]}, "Poland": {"totalIn": 827453, "totalOut": 3155509, "out": [{"country": "Belarus", "amount": 235853}, {"country": "Canada", "amount": 198476}, {"country": "France", "amount": 122152}, {"country": "Germany", "amount": 613768}, {"country": "Israel", "amount": 117287}, {"country": "Italy", "amount": 117309}, {"country": "United Kingdom", "amount": 521446}, {"country": "United States", "amount": 487934}], "in": [{"country": "Belarus", "amount": 112197}, {"country": "Germany", "amount": 104710}, {"country": "Ukraine", "amount": 332950}]}, "Eritrea": {"totalIn": 16484, "totalOut": 942238, "out": [{"country": "Ethiopia", "amount": 290383}, {"country": "Sudan", "amount": 458042}], "in": []}, "Mayotte": {"totalIn": 71735, "totalOut": 1040, "out": [], "in": []}, "New Caledonia": {"totalIn": 59767, "totalOut": 2269, "out": [], "in": []}, "Sri Lanka": {"totalIn": 339915, "totalOut": 1847829, "out": [{"country": "Canada", "amount": 123012}, {"country": "India", "amount": 161472}, {"country": "Jordan", "amount": 102709}, {"country": "Kuwait", "amount": 208893}, {"country": "Saudi Arabia", "amount": 391173}, {"country": "United Arab Emirates", "amount": 161068}, {"country": "United Kingdom", "amount": 113448}], "in": [{"country": "India", "amount": 336352}]}, "Latvia": {"totalIn": 335022, "totalOut": 275177, "out": [{"country": "Russian Federation", "amount": 105031}], "in": [{"country": "Russian Federation", "amount": 203920}]}, "Guyana": {"totalIn": 11599, "totalOut": 433473, "out": [{"country": "Canada", "amount": 101505}, {"country": "United States", "amount": 263147}], "in": []}, "Hong Kong, China": {"totalIn": 2741800, "totalOut": 718990, "out": [{"country": "Canada", "amount": 250786}, {"country": "United States", "amount": 214572}], "in": [{"country": "China", "amount": 2224503}]}, "Honduras": {"totalIn": 24344, "totalOut": 569731, "out": [{"country": "United States", "amount": 469202}], "in": []}, "Myanmar": {"totalIn": 88695, "totalOut": 514667, "out": [{"country": "Thailand", "amount": 288487}], "in": []}, "Equatorial Guinea": {"totalIn": 7447, "totalOut": 103130, "out": [], "in": []}, "Tunisia": {"totalIn": 33591, "totalOut": 651737, "out": [{"country": "France", "amount": 302363}, {"country": "Italy", "amount": 121708}], "in": []}, "Nicaragua": {"totalIn": 40130, "totalOut": 729242, "out": [{"country": "Costa Rica", "amount": 373548}, {"country": "United States", "amount": 242886}], "in": []}, "Congo, Dem. Rep.": {"totalIn": 444672, "totalOut": 914787, "out": [{"country": "Rwanda", "amount": 372964}], "in": []}, "Serbia": {"totalIn": 525388, "totalOut": 196013, "out": [{"country": "Austria", "amount": 130844}], "in": []}, "Botswana": {"totalIn": 114838, "totalOut": 63092, "out": [], "in": []}, "United Kingdom": {"totalIn": 6955738, "totalOut": 4666172, "out": [{"country": "Australia", "amount": 1207837}, {"country": "Canada", "amount": 674746}, {"country": "France", "amount": 172836}, {"country": "Germany", "amount": 154826}, {"country": "Ireland", "amount": 397465}, {"country": "New Zealand", "amount": 268085}, {"country": "Spain", "amount": 411074}, {"country": "United States", "amount": 701093}], "in": [{"country": "Australia", "amount": 121775}, {"country": "Bangladesh", "amount": 210244}, {"country": "China", "amount": 100959}, {"country": "France", "amount": 128020}, {"country": "Germany", "amount": 299753}, {"country": "India", "amount": 657792}, {"country": "Ireland", "amount": 422569}, {"country": "Italy", "amount": 108244}, {"country": "Jamaica", "amount": 158203}, {"country": "Kenya", "amount": 152999}, {"country": "Nigeria", "amount": 150918}, {"country": "Pakistan", "amount": 451712}, {"country": "Philippines", "amount": 114489}, {"country": "Poland", "amount": 521446}, {"country": "Somalia", "amount": 110326}, {"country": "South Africa", "amount": 225856}, {"country": "Sri Lanka", "amount": 113448}, {"country": "United States", "amount": 183183}, {"country": "Zimbabwe", "amount": 115530}]}, "Gambia, The": {"totalIn": 290104, "totalOut": 64905, "out": [], "in": [{"country": "Senegal", "amount": 177306}]}, "Greece": {"totalIn": 1132794, "totalOut": 1209813, "out": [{"country": "Australia", "amount": 140114}, {"country": "Germany", "amount": 470350}, {"country": "United States", "amount": 151239}], "in": [{"country": "Albania", "amount": 676846}]}, "Paraguay": {"totalIn": 161306, "totalOut": 510839, "out": [{"country": "Argentina", "amount": 307510}], "in": []}, "Namibia": {"totalIn": 138870, "totalOut": 16532, "out": [], "in": []}, "Comoros": {"totalIn": 13525, "totalOut": 38641, "out": [], "in": []}};
  var places = {"Korea, Rep.": {"lat": 36.5, "lon": 127.6}, "Korea, Dem. Rep.": {"lat": 40.2, "lon": 127.3}, "Macedonia, FYR": {"lat": 41.5, "lon": 21.5}, "Micronesia, Fed. Sts.": {"lat": 6.9, "lon": 158.2}, "Canada": {"lat": 56.130366, "lon": -106.346771}, "Turkmenistan": {"lat": 38.969719, "lon": 59.556278}, "Lao PDR": {"lat": 17.9454864, "lon": 102.620515}, "Lithuania": {"lat": 55.169438, "lon": 23.881275}, "Cambodia": {"lat": 12.565679, "lon": 104.990963}, "Ethiopia": {"lat": 9.145000000000001, "lon": 40.489673}, "Aruba": {"lat": 12.52111, "lon": -69.968338}, "Swaziland": {"lat": -26.522503, "lon": 31.465866}, "Argentina": {"lat": -38.416097, "lon": -63.61667199999999}, "Bolivia": {"lat": -16.290154, "lon": -63.58865299999999}, "Bahamas, The": {"lat": 25.03428, "lon": -77.39627999999999}, "Burkina Faso": {"lat": 12.238333, "lon": -1.561593}, "Ghana": {"lat": 7.946527, "lon": -1.023194}, "Saudi Arabia": {"lat": 23.885942, "lon": 45.079162}, "Japan": {"lat": 36.204824, "lon": 138.252924}, "Channel Islands": {"lat": 33.9986014, "lon": -119.8583772}, "American Samoa": {"lat": -14.305941, "lon": -170.6962002}, "Northern Mariana Islands": {"lat": 15.0979, "lon": 145.6739}, "Slovenia": {"lat": 46.151241, "lon": 14.995463}, "Guatemala": {"lat": 15.783471, "lon": -90.23075899999999}, "Bosnia and Herzegovina": {"lat": 43.915886, "lon": 17.679076}, "Kuwait": {"lat": 29.31166, "lon": 47.481766}, "Russian Federation": {"lat": 61.52401, "lon": 105.318756}, "Jordan": {"lat": 30.585164, "lon": 36.238414}, "St. Lucia": {"lat": 13.909444, "lon": -60.978893}, "Congo, Rep.": {"lat": 19.4315957, "lon": -70.6945063}, "Dominica": {"lat": 15.414999, "lon": -61.37097600000001}, "Liberia": {"lat": 6.428055, "lon": -9.429499000000002}, "Maldives": {"lat": 1.9772469, "lon": 73.5361035}, "Pakistan": {"lat": 30.375321, "lon": 69.34511599999999}, "Oman": {"lat": 21.512583, "lon": 55.923255}, "Tanzania": {"lat": -6.369028, "lon": 34.888822}, "Albania": {"lat": 41.153332, "lon": 20.168331}, "Gabon": {"lat": -0.803689, "lon": 11.609444}, "Monaco": {"lat": 43.73841760000001, "lon": 7.424615799999999}, "New Zealand": {"lat": -40.900557, "lon": 174.885971}, "Jamaica": {"lat": 18.109581, "lon": -77.297508}, "Greenland": {"lat": 71.706936, "lon": -42.604303}, "Samoa": {"lat": -13.759029, "lon": -172.104629}, "Slovak Republic": {"lat": 48.669026, "lon": 19.699024}, "United Arab Emirates": {"lat": 23.424076, "lon": 53.847818}, "C\u00f4te d'Ivoire": {"lat": 7.539988999999999, "lon": -5.547079999999999}, "Uruguay": {"lat": -32.522779, "lon": -55.765835}, "India": {"lat": 20.593684, "lon": 78.96288}, "Azerbaijan": {"lat": 40.143105, "lon": 47.576927}, "Lesotho": {"lat": -29.609988, "lon": 28.233608}, "Kenya": {"lat": -0.023559, "lon": 37.906193}, "Tajikistan": {"lat": 38.861034, "lon": 71.276093}, "Guam": {"lat": 13.444304, "lon": 144.793731}, "Turkey": {"lat": 38.963745, "lon": 35.243322}, "Afghanistan": {"lat": 33.93911, "lon": 67.709953}, "Venezuela, RB": {"lat": 10.1840932, "lon": -64.684618}, "Bangladesh": {"lat": 23.684994, "lon": 90.356331}, "Mauritania": {"lat": 21.00789, "lon": -10.940835}, "Solomon Islands": {"lat": -9.64571, "lon": 160.156194}, "Turks and Caicos Islands": {"lat": 21.694025, "lon": -71.797928}, "San Marino": {"lat": 43.94236, "lon": 12.457777}, "French Polynesia": {"lat": -17.679742, "lon": -149.406843}, "France": {"lat": 46.227638, "lon": 2.213749}, "Syrian Arab Republic": {"lat": 34.80207499999999, "lon": 38.996815}, "Bermuda": {"lat": 32.3078, "lon": -64.7505}, "Somalia": {"lat": 5.152149, "lon": 46.199616}, "Peru": {"lat": -9.189967, "lon": -75.015152}, "Vanuatu": {"lat": -15.376706, "lon": 166.959158}, "Nigeria": {"lat": 9.081999, "lon": 8.675277}, "Seychelles": {"lat": -4.679574, "lon": 55.491977}, "Norway": {"lat": 60.47202399999999, "lon": 8.468945999999999}, "Malawi": {"lat": -13.254308, "lon": 34.301525}, "West Bank and Gaza": {"lat": 31.0354252, "lon": 31.3791056}, "Benin": {"lat": 9.30769, "lon": 2.315834}, "Macao, China": {"lat": 22.198745, "lon": 113.543873}, "Cuba": {"lat": 21.521757, "lon": -77.781167}, "Cameroon": {"lat": 7.369721999999999, "lon": 12.354722}, "Montenegro": {"lat": 42.708678, "lon": 19.37439}, "Togo": {"lat": 8.619543, "lon": 0.824782}, "China": {"lat": 35.86166, "lon": 104.195397}, "Armenia": {"lat": 40.069099, "lon": 45.038189}, "Timor-Leste": {"lat": -8.874217, "lon": 125.727539}, "Dominican Republic": {"lat": 18.735693, "lon": -70.162651}, "Ukraine": {"lat": 48.379433, "lon": 31.16558}, "Bahrain": {"lat": 26.0667, "lon": 50.5577}, "Tonga": {"lat": -21.178986, "lon": -175.198242}, "Finland": {"lat": 61.92410999999999, "lon": 25.748151}, "Libya": {"lat": 26.3351, "lon": 17.228331}, "Cayman Islands": {"lat": 19.3133, "lon": -81.2546}, "Central African Republic": {"lat": 6.611110999999999, "lon": 20.939444}, "Mauritius": {"lat": -20.348404, "lon": 57.55215200000001}, "Liechtenstein": {"lat": 47.166, "lon": 9.555373}, "Belarus": {"lat": 53.709807, "lon": 27.953389}, "Mali": {"lat": 17.570692, "lon": -3.996166}, "Sweden": {"lat": 60.12816100000001, "lon": 18.643501}, "Bulgaria": {"lat": 42.733883, "lon": 25.48583}, "United States": {"lat": 37.09024, "lon": -95.712891}, "Romania": {"lat": 45.943161, "lon": 24.96676}, "Angola": {"lat": -11.202692, "lon": 17.873887}, "Egypt, Arab Rep.": {"lat": 30.0390502, "lon": 31.2330754}, "South Africa": {"lat": -30.559482, "lon": 22.937506}, "St. Vincent and the Grenadines": {"lat": 13.2533835, "lon": -61.196251}, "Cyprus": {"lat": 35.126413, "lon": 33.429859}, "Brunei Darussalam": {"lat": 4.535277, "lon": 114.727669}, "Qatar": {"lat": 25.354826, "lon": 51.183884}, "Malaysia": {"lat": 4.210484, "lon": 101.975766}, "Austria": {"lat": 47.516231, "lon": 14.550072}, "Vietnam": {"lat": 14.058324, "lon": 108.277199}, "Mozambique": {"lat": -18.665695, "lon": 35.529562}, "Uganda": {"lat": 1.373333, "lon": 32.290275}, "Kyrgyz Republic": {"lat": 41.20438, "lon": 74.766098}, "Hungary": {"lat": 47.162494, "lon": 19.503304}, "Niger": {"lat": 17.607789, "lon": 8.081666}, "Isle of Man": {"lat": 54.236107, "lon": -4.548056}, "Brazil": {"lat": -14.235004, "lon": -51.92528}, "Virgin Islands (U.S.)": {"lat": 18.335765, "lon": -64.896335}, "Guinea": {"lat": 9.945587, "lon": -9.696645}, "Panama": {"lat": 8.537981, "lon": -80.782127}, "Costa Rica": {"lat": 9.748916999999999, "lon": -83.753428}, "Luxembourg": {"lat": 49.815273, "lon": 6.129582999999999}, "Cape Verde": {"lat": 15.1217288, "lon": -23.6050817}, "Andorra": {"lat": 42.506285, "lon": 1.521801}, "Gibraltar": {"lat": 36.140751, "lon": -5.353585}, "Ireland": {"lat": 53.41291, "lon": -8.24389}, "Palau": {"lat": 7.514979999999999, "lon": 134.58252}, "Faeroe Islands": {"lat": 61.89263500000001, "lon": -6.911805999999999}, "Ecuador": {"lat": -1.831239, "lon": -78.18340599999999}, "Czech Republic": {"lat": 49.81749199999999, "lon": 15.472962}, "Australia": {"lat": -25.274398, "lon": 133.775136}, "Algeria": {"lat": 28.033886, "lon": 1.659626}, "El Salvador": {"lat": 13.794185, "lon": -88.89653}, "Tuvalu": {"lat": -10.7280717, "lon": 179.4726562}, "St. Kitts and Nevis": {"lat": 17.357822, "lon": -62.782998}, "Marshall Islands": {"lat": 7.131474, "lon": 171.184478}, "Chile": {"lat": -35.675147, "lon": -71.542969}, "Puerto Rico": {"lat": 18.220833, "lon": -66.590149}, "Belgium": {"lat": 50.503887, "lon": 4.469936}, "Kiribati": {"lat": 1.8668577, "lon": -157.3599202}, "Haiti": {"lat": 18.971187, "lon": -72.285215}, "Belize": {"lat": 17.189877, "lon": -88.49765}, "Sierra Leone": {"lat": 8.460555, "lon": -11.779889}, "Georgia": {"lat": 42.2, "lon": 43.3}, "Denmark": {"lat": 56.26392, "lon": 9.501785}, "Philippines": {"lat": 12.879721, "lon": 121.774017}, "Moldova": {"lat": 47.411631, "lon": 28.369885}, "Portugal": {"lat": 39.39987199999999, "lon": -8.224454}, "Morocco": {"lat": 31.791702, "lon": -7.092619999999999}, "Croatia": {"lat": 45.1, "lon": 15.2}, "Mongolia": {"lat": 46.862496, "lon": 103.846656}, "Guinea-Bissau": {"lat": 11.803749, "lon": -15.180413}, "Thailand": {"lat": 15.870032, "lon": 100.992541}, "Switzerland": {"lat": 46.818188, "lon": 8.227511999999999}, "Grenada": {"lat": 12.1165, "lon": -61.67899999999999}, "Yemen, Rep.": {"lat": 22.5919842, "lon": 46.5100962}, "Iraq": {"lat": 33.223191, "lon": 43.679291}, "Chad": {"lat": 15.454166, "lon": 18.732207}, "Estonia": {"lat": 58.595272, "lon": 25.013607}, "Kosovo": {"lat": 42.6026359, "lon": 20.902977}, "Mexico": {"lat": 23.634501, "lon": -102.552784}, "Lebanon": {"lat": 33.854721, "lon": 35.862285}, "Uzbekistan": {"lat": 41.377491, "lon": 64.585262}, "Djibouti": {"lat": 11.825138, "lon": 42.590275}, "Rwanda": {"lat": -1.940278, "lon": 29.873888}, "Antigua and Barbuda": {"lat": 17.060816, "lon": -61.796428}, "Spain": {"lat": 40.46366700000001, "lon": -3.74922}, "Colombia": {"lat": 4.570868, "lon": -74.297333}, "Burundi": {"lat": -3.373056, "lon": 29.918886}, "Fiji": {"lat": -17.713371, "lon": 178.065032}, "Barbados": {"lat": 13.193887, "lon": -59.543198}, "Madagascar": {"lat": -18.766947, "lon": 46.869107}, "Italy": {"lat": 41.87194, "lon": 12.56738}, "Bhutan": {"lat": 27.514162, "lon": 90.433601}, "Sudan": {"lat": 12.862807, "lon": 30.217636}, "Nepal": {"lat": 28.394857, "lon": 84.12400799999999}, "Singapore": {"lat": 1.352083, "lon": 103.819836}, "Malta": {"lat": 35.937496, "lon": 14.375416}, "Netherlands": {"lat": 52.132633, "lon": 5.291265999999999}, "Suriname": {"lat": 3.919305, "lon": -56.027783}, "S\u00e3o Tom\u00e9 and Principe": {"lat": 0.18636, "lon": 6.613080999999999}, "Netherlands Antilles": {"lat": 12.2248767, "lon": -68.81088489999999}, "Iran, Islamic Rep.": {"lat": 38.4739835, "lon": 47.0605507}, "Israel": {"lat": 31.046051, "lon": 34.851612}, "Indonesia": {"lat": -0.789275, "lon": 113.921327}, "Iceland": {"lat": 64.963051, "lon": -19.020835}, "Zambia": {"lat": -13.133897, "lon": 27.849332}, "Senegal": {"lat": 14.497401, "lon": -14.452362}, "Papua New Guinea": {"lat": -6.314992999999999, "lon": 143.95555}, "Trinidad and Tobago": {"lat": 10.691803, "lon": -61.222503}, "Zimbabwe": {"lat": -19.015438, "lon": 29.154857}, "Germany": {"lat": 51.165691, "lon": 10.451526}, "Kazakhstan": {"lat": 48.019573, "lon": 66.923684}, "Poland": {"lat": 51.919438, "lon": 19.145136}, "Eritrea": {"lat": 15.179384, "lon": 39.782334}, "Mayotte": {"lat": -12.8275, "lon": 45.166244}, "New Caledonia": {"lat": -20.904305, "lon": 165.618042}, "Sri Lanka": {"lat": 7.873053999999999, "lon": 80.77179699999999}, "Latvia": {"lat": 56.879635, "lon": 24.603189}, "Guyana": {"lat": 4.860416, "lon": -58.93018}, "Hong Kong, China": {"lat": 22.396428, "lon": 114.109497}, "Honduras": {"lat": 15.199999, "lon": -86.241905}, "Myanmar": {"lat": 21.913965, "lon": 95.956223}, "Equatorial Guinea": {"lat": 1.650801, "lon": 10.267895}, "Tunisia": {"lat": 33.886917, "lon": 9.537499}, "Nicaragua": {"lat": 12.865416, "lon": -85.207229}, "Congo, Dem. Rep.": {"lat": 9.007017, "lon": 38.7697892}, "Serbia": {"lat": 44.016521, "lon": 21.005859}, "Botswana": {"lat": -22.328474, "lon": 24.684866}, "United Kingdom": {"lat": 55.378051, "lon": -3.435973}, "Gambia, The": {"lat": 13.443182, "lon": -15.310139}, "Greece": {"lat": 39.074208, "lon": 21.824312}, "Paraguay": {"lat": -23.442503, "lon": -58.443832}, "Namibia": {"lat": -22.95764, "lon": 18.49041}, "Comoros": {"lat": -11.6455, "lon": 43.3333}};

  // HELPERS
  function getXY(p) {
    return {
      x: p.lon * 2.6938 + 465.4,
      y: p.lat * -2.6938 + 227.066
    };
  };

  function length(p0, p1) {
    return Math.sqrt(Math.pow(p1.x - p0.x, 2) + Math.pow(p1.x - p0.x, 2));
  }

  function midpoint(p0, p1) {
    return {x: p0.x + (p1.x - p0.x) / 2, y: p0.y + (p1.y - p0.y) / 2};
  }

  function dir(p0, p1) {
    var l = length(p0, p1);
    return {x: (p1.x - p0.x) / l, y: (p1.y - p0.y) / l};
  }

  function orthogonal(dir) {
    return {x: -dir.y, y: dir.x};
  }

  function quadraticMidpointFromConnection(p0, p1, k) {
    var l = length(p0, p1);
    var d = dir(p0, p1); 
    var orth = orthogonal(d);
    var mid = midpoint(p0, p1);
    var kl = l * k;
    return {x: mid.x + kl * orth.x, y: mid.y + kl * orth.y};
  }

  // Custom attribute function that returns segment of curve
  paper.ca.arc = function(x) {
    var length = this.attr('length');
    var path = this.attr('original');
    var subPath = Raphael.getSubpath(path, 0, x*length);
    return {path: subPath};
  }

  // Empty functions to allow us to add static custom attributes
  paper.ca.length = function() {}
  paper.ca.original = function() {}

  function qPath(start, mid, end) {
    var path = "M"+start.x+" "+start.y;
    path += " Q"+mid.x+" "+mid.y;
    path += " "+end.x+" "+end.y;
    return path;
  }

  // From http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
  function numberWithCommas(x) {
    return x;
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // RENDERING
  function createOrigins() {
    for(c in data) {
      var total = mode === 'in' ? data[c].totalIn : data[c].totalOut;
      var oXY = getXY(places[c]);

      var rad = 0;
      if(total >= threshold)
        rad = total * amountScale > 1 ? total * amountScale : 1;

      var o = paper.
        circle(oXY.x, oXY.y, rad).
        attr({'fill':'steelblue', 'stroke':'none'}).
        data('country', c);
      o.hover(function() {showCurves(this.data('country'));});

      // console.log(o);

      origins.push({country: c, element: o});
    }
    console.log(origins);
  }

  function updateOrigins() {
    for(var i = 0; i < origins.length; i++) {
      var c = origins[i].country;
      var total = mode === 'in' ? data[c].totalIn : data[c].totalOut;
      var rad = 0;
      if(total >= threshold)
        rad = total * amountScale > 1 ? total * amountScale : 1;

      var currentRad = origins[i].element.attr('r');

      if(Math.abs(rad - currentRad) > 0.01) {
        var anim = Raphael.animation({r: rad}, 200, '>');
        origins[i].element.animate(anim);
      }
    }
  }
  

  function updateLegend(country) {
    var movement = mode === 'in' ? 'Entering' : 'Leaving';
    $('#legend h2').html(movement + ' ' + country);

    var migrations = data[country][mode];
    var subtotal = 0;

    var $table = $('#legend .content');
    $table.html('');
    for(var i=0; i<migrations.length; i++) {
      subtotal += migrations[i].amount;
      migrations[i].amount = numberWithCommas(migrations[i].amount)
      $table.append(tim(template, migrations[i]));

      if(i === maxCurves)
        break;
    }
    var total = mode === 'in' ? data[country].totalIn : data[country].totalOut;
    var other = total - subtotal;

    $table.append(tim(template, {country: 'Other', amount: numberWithCommas(other)}));
    $table.append(tim(template, {country: 'Total', amount: numberWithCommas(total)}));
  }

  function showCurves(country) {
    if(country === current.country)
      return;

    // console.log(country);

    removeCurrent();
    current.country = country;

    var connections = data[country][mode];
    // console.log(connections);

    for(var i=0; i<connections.length; i++) {
      // console.log('connections is '+connections[i].country, places[connections[i].country], p0, p1);
      var p0, p1, path;

      if(mode === 'out') {
        p0 = getXY(places[country]);
        p1 = getXY(places[connections[i].country]);
      } else {
        p1 = getXY(places[country]);
        p0 = getXY(places[connections[i].country]);
      }
      path = qPath(p0, quadraticMidpointFromConnection(p0, p1, -.5), p1);

      var curvePath = paper.path(path);
      var length = Raphael.getTotalLength(path);

      var width = connections[i].amount * amountScale * 4.5;
      // console.log(connections[i].amount, width);

      // Big hack for Mexico? - fat line has trouble fitting in!
      // if(country === 'Mexico')
      //   width = 0.3 * width;

      curvePath.attr( { opacity: 0,
                        original: path, 
                        length: length, 
                        'arrow-end':'short',

                        'stroke':'steelblue', 
                        'stroke-width': width} );

      curvePath.attr( {arc: 0.1} );

      current.elements.push(curvePath);

      // Animate
      var anim = Raphael.animation({arc: 1.1, opacity: 0.7}, 1000, '>');
      curvePath.animate(anim.delay(i*300));

      // Limit no. curves (for performance)
      if( i === maxCurves )
        break;
    }
    updateLegend(country);
  }

  function removeCurrent() {
    for(var i=0; i<current.elements.length; i++)
      current.elements[i].remove();

    $('#legend .content').html('');
    $('#legend h2').html('');

    current = { country : null, elements : [] };
  }


  // INITIALISATION
  function init() {
    paper.setViewBox(170, 0, 770, 300);

    // Draw worldmap. Data taken from http://raphaeljs.com/world/
    for (var country in worldmap.shapes) {
      paper.path(worldmap.shapes[country]).attr({stroke: "#666", "stroke-width": 0.5, fill: "#f0efeb", "stroke-opacity": 0.25});
    }

    initData();
    createOrigins();

    // To get us started, highlight Britain
    showCurves('United Kingdom');

    jQuery('#immigrants').on('click', function(e) {
      mode = 'in';
      removeCurrent();
      updateOrigins();
      jQuery(this).attr('disabled', 'disabled');
      jQuery('#emigrants').removeAttr('disabled');
    });
    jQuery('#emigrants').on('click', function() {
      mode = 'out';
      removeCurrent();
      updateOrigins();
      jQuery(this).attr('disabled', 'disabled');
      jQuery('#immigrants').removeAttr('disabled');
    });
  }

  function initData() {
    // sort countries
    for(var c in data) {
      data[c].out = data[c].out.sort(function(a, b) {return parseInt(a.amount) < parseInt(b.amount) ? 1 : -1;});
    }
    for(var c in data) {
      data[c].in = data[c].in.sort(function(a, b) {return parseInt(a.amount) < parseInt(b.amount) ? 1 : -1;});
    }
  }

  init();
})();
